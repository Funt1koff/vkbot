<!-- src/main/resources/templates/game_save.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <title>Создание игры (JSON) с предпросмотром</title>
    <style>
        /* Общие стили для наглядности */
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom right, #E6F7FF, #B3DAF1);
            font-family: Arial, sans-serif;
        }

        .container {
            max-width: 1200px;
            margin: 2em auto;
            background-color: #FFFFFF;
            padding: 1.5em;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        h1, h2, h4 {
            color: #003366;
            margin-top: 0;
        }

        .form-group {
            margin-bottom: 1em;
        }

        .form-group label {
            font-weight: bold;
        }

        .btn {
            background: #007ACC;
            color: #fff;
            padding: 0.6em 1.2em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-weight: bold;
            transition: background 0.3s ease;
            margin-right: 0.5em;
        }

        .btn:hover {
            background: #005EA8;
        }

        .btn-danger {
            background: #FF4D4F;
        }

        .btn-danger:hover {
            background: #D9363E;
        }

        .steps-block, .options-block {
            border: 1px solid #B3DAF1;
            border-radius: 6px;
            padding: 1em;
            margin-bottom: 1em;
        }

        .steps-block {
            background-color: #f8fcff;
        }

        .options-block {
            background-color: #ffffff;
            margin-left: 1em;
        }

        .preview {
            margin-top: 2em;
            border-top: 2px dashed #999;
            padding-top: 1em;
        }

        .step-preview {
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 1em;
            margin-bottom: 1em;
            background: #fafafa;
        }

        .step-preview h4 {
            margin-top: 0;
            margin-bottom: 0.5em;
        }

        .step-preview img {
            max-width: 150px;
            display: block;
            margin-bottom: 0.5em;
            border: 2px solid #B3DAF1;
            border-radius: 4px;
        }

        .option-preview {
            margin-left: 1.2em;
            margin-top: 0.5em;
        }
    </style>
</head>
<body>
    {#include navbar /}

<div class="container">
    <h1>Создание игры</h1>

    <form id="gameForm" onsubmit="event.preventDefault(); submitGame();">
        <div class="form-group">
            <label for="botStartCommand">Стартовая команда:</label>
            <input type="text"
                   id="botStartCommand"
                   placeholder="Должна быть уникальной"
                   value="{botStartCommand ?: ''}"/>
        </div>

        <h2>Шаги игры:</h2>
        <div id="stepsContainer"></div>

        <button type="button" class="btn" onclick="addStep()">Добавить шаг</button>
        <hr/>
        <button type="submit" class="btn">Сохранить</button>
    </form>

    <div class="preview">
        <h2>Предпросмотр</h2>
        <p><strong>Команда бота:</strong> <span id="previewBotCommand"></span></p>
        <div id="previewSteps"></div>
    </div>
</div>

<script>
    /**
     * Перехватываем ввод в форме, чтобы обновлять предпросмотр в реальном времени.
     */
    const gameForm = document.getElementById('gameForm');
    gameForm.addEventListener('input', updatePreview);

    /**
     * Добавляет новый шаг (step) в DOM.
     */
    function addStep() {
        const stepsContainer = document.getElementById('stepsContainer');
        const stepIndex = stepsContainer.children.length;

        // Создаём обёртку для шага
        const stepDiv = document.createElement('div');
        stepDiv.className = 'steps-block';
        stepDiv.id = `stepBlock-${stepIndex}`;

        // Заполняем HTML полями для stepKey, stepOrder, imageUrl, caption
        // + контейнер опций
        // + кнопка "Добавить опцию"
        // + кнопка "Удалить шаг"
        stepDiv.innerHTML = `
      <h4>Шаг #${stepIndex + 1}</h4>
      <div class="form-group">
          <label>stepKey:</label>
          <input type="text" id="stepKey-${stepIndex}"
                 placeholder="Уникальный ключ шага, для ссылки в опциях"/>
      </div>
      <div class="form-group">
          <label>Порядок шага (stepOrder):</label>
          <input type="number" id="stepOrder-${stepIndex}" value="${stepIndex + 1}" />
      </div>
      <div class="form-group">
          <label>URL картинки (imageUrl):</label>
          <input type="text" id="imageUrl-${stepIndex}" placeholder="http://..."/>
      </div>
      <div class="form-group">
          <label>Текст (caption):</label>
          <textarea id="caption-${stepIndex}" rows="2"
                    placeholder="Описание / текст шага"></textarea>
      </div>

      <h4>Опции шага:</h4>
      <div id="optionContainer-${stepIndex}"></div>

      <button type="button" class="btn" onclick="addOption(${stepIndex})">
        Добавить опцию
      </button>
      <button type="button" class="btn btn-danger" onclick="removeStep(${stepIndex})">
        Удалить шаг
      </button>
    `;

        stepsContainer.appendChild(stepDiv);

        // Обновляем предпросмотр (чтобы сразу увидеть новый пустой шаг)
        updatePreview();
    }

    /**
     * Удаляем целиком шаг из DOM.
     */
    function removeStep(stepIndex) {
        const stepDiv = document.getElementById(`stepBlock-${stepIndex}`);
        if (stepDiv) {
            stepDiv.remove();
        }
        updatePreview();
    }

    /**
     * Добавляет новую опцию к конкретному шагу.
     */
    function addOption(stepIndex) {
        const containerId = `optionContainer-${stepIndex}`;
        const optionContainer = document.getElementById(containerId);

        // Считаем, сколько уже опций
        const optionIndex = optionContainer.children.length;

        // Создаём div для опции
        const optionDiv = document.createElement('div');
        optionDiv.className = 'options-block';
        optionDiv.id = `optionBlock-${stepIndex}-${optionIndex}`;
        optionDiv.innerHTML = `
      <div class="form-group">
          <label>Текст кнопки (buttonText):</label>
          <input type="text" id="optionButtonText-${stepIndex}-${optionIndex}"
                 placeholder="Напр.: Идти дальше"/>
      </div>
      <div class="form-group">
          <label>Финальная опция (finalOption):</label>
          <input type="checkbox" id="optionFinal-${stepIndex}-${optionIndex}" />
      </div>
      <div class="form-group">
          <label>Следующий шаг (stepKey):</label>
          <input type="text" id="nextStepKey-${stepIndex}-${optionIndex}"
                 placeholder="Укажите stepKey следующего шага или оставьте пустым"/>
      </div>
      <button type="button" class="btn btn-danger"
              onclick="removeOption(${stepIndex}, ${optionIndex})">
        Удалить опцию
      </button>
    `;

        optionContainer.appendChild(optionDiv);

        updatePreview();
    }

    /**
     * Удаляем опцию из DOM.
     */
    function removeOption(stepIndex, optionIndex) {
        const optionDiv = document.getElementById(`optionBlock-${stepIndex}-${optionIndex}`);
        if (optionDiv) {
            optionDiv.remove();
        }
        updatePreview();
    }

    /**
     * Собирает все данные со страницы (поля формы) в объект GameSaveDto.
     * (Эта же логика используется в updatePreview() и в submitGame()).
     * Возвращает объект { botStartCommand, gameSteps: [...] }.
     */
    function gatherFormData() {
        // 1) Стартовая команда
        const botStartCommand = document.getElementById('botStartCommand').value.trim();

        // 2) Шаги
        const stepsContainer = document.getElementById('stepsContainer');
        const stepBlocks = stepsContainer.querySelectorAll('.steps-block');

        const gameSteps = [];
        stepBlocks.forEach((block, i) => {
            const stepKeyValue = document.getElementById(`stepKey-${i}`)?.value.trim() || '';
            const stepOrderValue = parseInt(document.getElementById(`stepOrder-${i}`)?.value || '0', 10);
            const imageUrlValue = document.getElementById(`imageUrl-${i}`)?.value.trim() || '';
            const captionValue = document.getElementById(`caption-${i}`)?.value.trim() || '';

            // Опции
            const optionContainer = document.getElementById(`optionContainer-${i}`);
            const optionBlocks = optionContainer.querySelectorAll('.options-block');
            const options = [];
            optionBlocks.forEach((optBlock, j) => {
                const buttonText = document.getElementById(`optionButtonText-${i}-${j}`)?.value.trim() || '';
                const finalOption = document.getElementById(`optionFinal-${i}-${j}`)?.checked || false;
                const nextStepKey = document.getElementById(`nextStepKey-${i}-${j}`)?.value.trim() || '';

                let nextStep = null;
                if (nextStepKey) {
                    nextStep = {
                        stepKey: nextStepKey
                    };
                }

                options.push({
                    buttonText: buttonText,
                    finalOption: finalOption,
                    nextStep: nextStep
                });
            });

            gameSteps.push({
                stepKey: stepKeyValue,
                stepOrder: stepOrderValue,
                imageUrl: imageUrlValue,
                caption: captionValue,
                options: options
            });
        });

        // 3) Итоговый объект
        const gameSaveDto = {
            botStartCommand: botStartCommand,
            gameSteps: gameSteps
        };
        return gameSaveDto;
    }

    /**
     * "Живой" предпросмотр:
     *  - Считываем данные из формы
     *  - Заполняем блок #previewSteps.
     */
    function updatePreview() {
        const data = gatherFormData();

        // 1) Показать команду бота
        const previewCommandEl = document.getElementById('previewBotCommand');
        previewCommandEl.textContent = data.botStartCommand || '(нет команды)';

        // 2) Очищаем блок шагов
        const previewStepsEl = document.getElementById('previewSteps');
        previewStepsEl.innerHTML = '';

        // 3) Генерируем HTML для каждого шага
        data.gameSteps.forEach((step, index) => {
            // Создаём контейнер
            const stepDiv = document.createElement('div');
            stepDiv.className = 'step-preview';

            // Шаг №
            const stepHeader = document.createElement('h4');
            stepHeader.textContent = `Шаг #${step.stepOrder || index + 1}`;
            stepDiv.appendChild(stepHeader);

            // Картинка (если есть)
            if (step.imageUrl) {
                const img = document.createElement('img');
                img.src = step.imageUrl;
                img.alt = 'Step Image';
                stepDiv.appendChild(img);
            }

            // Текст
            const captionP = document.createElement('p');
            captionP.textContent = step.caption || '(нет описания)';
            stepDiv.appendChild(captionP);

            // Опции
            if (step.options && step.options.length > 0) {
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'option-preview';
                const optTitle = document.createElement('strong');
                optTitle.textContent = 'Опции:';
                optionsDiv.appendChild(optTitle);

                const ul = document.createElement('ul');
                step.options.forEach(opt => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${opt.buttonText || '...'} </strong>`
                        + (opt.finalOption ? ' (финальная) ' : '')
                        + (opt.nextStep?.stepKey ? ` → следующий шаг: ${opt.nextStep.stepKey}` : '');
                    ul.appendChild(li);
                });
                optionsDiv.appendChild(ul);
                stepDiv.appendChild(optionsDiv);
            }

            previewStepsEl.appendChild(stepDiv);
        });
    }

    /**
     * Отправляем JSON на сервер (AJAX).
     */
    function submitGame() {
        const gameSaveDto = gatherFormData();

        console.log('Отправляем JSON:', gameSaveDto);

        fetch('/game/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(gameSaveDto)
        })
            .then(async response => {
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`Ошибка: ${response.status} - ${text}`);
                }
                return response.text(); // или response.json(), если возвращаете JSON
            })
            .then(result => {
                console.log('Ответ от сервера:', result);
                // Перенаправляем на список игр:
                window.location.href = '/game/all';
            })
            .catch(err => {
                console.error('Ошибка при сохранении игры:', err);
                alert('Не удалось сохранить игру. Детали в консоли.');
            });
    }

    // При загрузке страницы — сразу запустим предпросмотр (на случай, если уже есть поля)
    updatePreview();
</script>
</body>
</html>
